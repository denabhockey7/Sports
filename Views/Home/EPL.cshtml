@using DenchikSportsRu.Models.Page;
@model Teams;

@{
    Layout = "_Layout";
}

<style>
    .team-name {
        text-align: left;
        font-weight: bold;
    }

    .h1 {
        text-align: center;
    }

    .team-logo {
        width: 30px;
        height: 30px;
        object-fit: contain;
        vertical-align: middle;
    }

    main {
        text-align: center;
        margin-right: 20px;
        margin-left: 20px;
    }

    .tables-container {
        display: flex;
        gap: 75px;
        justify-content: space-between;
    }

    .table-wrapper {
        flex: 1;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .leader-row {
        background-color: #e8f5e8;
    }

    .middle-row {
        background-color: #ffffff;
    }

    .team-name {
        text-align: left;
        font-weight: bold;
    }

    caption {
        caption-side: top;
        font-size: 1.2em;
        font-weight: 700;
        color: black;
        margin-bottom: 10px;
        text-align: center;
    }

    .table-epl {
        width: 100%;
        border-collapse: collapse;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
    }

        .table-epl caption {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            color: #fff;
            caption-side: top;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .table-epl thead {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .table-epl th,
        .table-epl td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-epl tbody tr {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .table-epl tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .table-epl tbody tr.selected {
            background-color: rgba(254, 180, 123, 0.2);
            box-shadow: 0 0 10px rgba(254, 180, 123, 0.3);
        }

            .table-epl tbody tr.selected td {
                font-weight: bold;
            }

    .game-setup {
        display: flex;
        flex-direction: column;
        gap: 30px;
        margin-top: 20px;
    }

    .confirm-btn {
        display: none;
        margin: 25px auto 0;
        padding: 15px 40px;
        background: linear-gradient(to right,, );
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px #4C0E0F;
    }

        .confirm-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px #4C0E0F;
        }

        .confirm-btn.active {
            display: block;
        }

    .custom-ratings {
        display: none;
        margin-top: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

        .custom-ratings.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

    .custom-ratings-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

        .custom-ratings-table th, .custom-ratings-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-ratings-table th {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .custom-ratings-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

    .setup-section {
        background-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
        justify-content: center;
        text-align: center;
    }

        .setup-section h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            text-align: center;
        }

            .setup-section h2 i {
                font-size: 1.6rem;
            }

    .in-game-screen {
        display: none;
        text-align: center;
        padding: 40px 20px;
        animation: fadeIn 0.8s ease;
    }

        .in-game-screen.active {
            display: block;
        }

    .game-title {
        font-size: 2.5rem;
        margin-bottom: 30px;
        background: linear-gradient(to right, #4C0E0F);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .game-message {
        font-size: 1.5rem;
        margin-bottom: 40px;
        color: #feb47b;
    }

    .final-ratings-table {
        width: 100%;
        max-width: initial;
        margin: 0 auto;
        border-collapse: collapse;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

        .final-ratings-table th {
            background-color: #4C0E0F;
            padding: 15px;
            font-size: 1.2rem;
            color: #FFFFFF;
        }

        .final-ratings-table td {
            padding: 15px;
            text-align: center;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .final-ratings-table tr:last-child td {
            border-bottom: none;
        }

        .final-ratings-table .team-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

    .restart-btn {
        margin-top: 40px;
        padding: 15px 40px;
        background: linear-gradient(to right, #4C0E0F, red);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px #4C0E0F;
    }

        .restart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px #4C0E0F;
        }

    .settings-options {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .settings-btn {
        flex: 1;
        min-width: 200px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        border-radius: 10px;
        color: white;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .settings-btn.selected {
            background: rgba(76, 14, 15, 0.3);
            border-color: #4C0E0F;
        }

    .settings-icon {
        font-size: 1.5rem;
    }

    .selected-team-info {
        background-color: rgba(76, 14, 15, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 4px solid #4C0E0F;
    }
</style>

<main id="content" class="site-main post-43 page type-page status-publish hentry">
    <div class="page-content">
        <div data-elementor-type="wp-page" data-elementor-id="43" class="elementor elementor-43" data-elementor-post-type="page">
            <section class="elementor-section elementor-top-section elementor-element elementor-element-df04e12 elementor-section-boxed elementor-section-height-default elementor-section-height-default" data-id="df04e12" data-element_type="section" data-settings="{&quot;jet_parallax_layout_list&quot;:[]}">
                <div class="elementor-container elementor-column-gap-no">
                    <div class="elementor-column elementor-col-100 elementor-top-column elementor-element elementor-element-65ee644" data-id="65ee644" data-element_type="column">
                        <div class="elementor-widget-wrap elementor-element-populated">
                            <div class="elementor-element elementor-element-09c7ee9 elementor-widget elementor-widget-jet-blog-smart-tiles" data-id="09c7ee9" data-element_type="widget" data-widget_type="jet-blog-smart-tiles.default">
                                <div class="elementor-widget-container">
                                    <div class="game-setup">
                                        <section class="setup-section" id="team-selection">
                                            <h2><i class="fas fa-users"></i>Выберите команду</h2>
                                            <img src="~/EPLphoto/Eplphoto.png" style="width: 300px; height: 150px;" asp-append-version="true" />
                                            @if (Model.List != null && Model.List.Any())
                                            {
                                                <table class="table table-striped">
                                                    <thead class="thead-dark">
                                                        <tr>
                                                            <th>Место</th>
                                                            <th></th>
                                                            <th>Команда</th>
                                                            <th>И</th>
                                                            <th>В</th>
                                                            <th>Н</th>
                                                            <th>П</th>
                                                            <th>ЗМ</th>
                                                            <th>ПМ</th>
                                                            <th>+/-</th>
                                                            <th>О</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @{
                                                            int position = 1;
                                                            foreach (var row in Model.List.OrderByDescending(x => x.points))
                                                            {
                                                                <tr class="team-row" data-team-id="@row.id" data-team-name="@row.team_name" data-team-photo="@row.team_photo" data-team-url="@row.team_url" data-wins="@row.wins" data-losses="@row.loses" data-goals="@row.goals" data-draws="@row.draws" data-misses="@row.misses" data-points="@row.points">
                                                                    <td>@position</td>
                                                                    <td><img src="/EPLphoto/@row.team_photo.@row.team_url" style="width: 30px; height: 30px; object-fit: contain;vertical-align: middle;" /></td>
                                                                    <td><strong>@row.team_name</strong></td>
                                                                    <td>@(row.wins + row.draws + row.loses)</td>
                                                                    <td>@row.wins</td>
                                                                    <td>@row.draws</td>
                                                                    <td>@row.loses</td>
                                                                    <td>@row.goals</td>
                                                                    <td>@row.misses</td>
                                                                    <td>@(row.goals - row.misses)</td>
                                                                    <td><strong>@row.points</strong></td>
                                                                </tr>
                                                                position++;
                                                            }
                                                        }
                                                    </tbody>
                                                </table>
                                            }
                                            else
                                            {
                                                <p>Нет данных для отображения</p>
                                            }
                                            <div>
                                                <section class="setup-section" id="settings-selection" style="display: none;">
                                                    <div id="selected-team-display" class="selected-team-info" style="display: none;">
                                                        <h2>Выбранная команда: <span id="selected-team-name"></span></h2>
                                                        <div id="selected-team-stats"></div>
                                                    </div>
                                                    <h2><i class="fas fa-cog"></i> Выберите тип настроек</h2>
                                                    <div class="settings-options">
                                                        <button class="settings-btn" id="default-settings">
                                                            <i class="fas fa-bolt settings-icon"></i>
                                                            <span>По умолчанию</span>
                                                            <small>Использовать стандартные рейтинги</small>
                                                        </button>
                                                        <button class="settings-btn" id="custom-settings">
                                                            <i class="fas fa-sliders-h settings-icon"></i>
                                                            <span>Кастомизированные</span>
                                                            <small>Настроить рейтинги вручную</small>
                                                        </button>
                                                    </div>

                                                    <div class="custom-ratings" id="custom-ratings">
                                                        <p>Установите рейтинг для каждой команды (от 1 до 100):</p>
                                                        <div class="table-epl">
                                                            <table class="table-epl">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Команда</th>
                                                                        <th>Рейтинг</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="custom-table-epl">
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>


                                                    <button class="confirm-btn" id="confirm-btn">Подтвердить и начать игру</button>
                                                </section>
                                            </div>
                                        </section>
                                        <section class="in-game-screen" id="in-game-screen">
                                            <h2 class="game-title">Вы в игре!</h2>
                                            <p class="game-message" id="selected-team-message"></p>

                                            <table class="final-ratings-table">
                                                <thead>
                                                    <tr>
                                                        <th>Место</th>
                                                        <th></th>
                                                        <th>Команда</th>
                                                        <th>В</th>
                                                        <th>Н</th>
                                                        <th>П</th>
                                                        <th>ЗМ</th>
                                                        <th>ПМ</th>
                                                        <th>+/-</th>
                                                        <th>О</th>
                                                        <th>Рейтинг</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="final-ratings-table">
                                                </tbody>
                                            </table>

                                            <button class="restart-btn" id="restart-btn"><i class="fas fa-redo"></i> Начать заново</button>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>
<script>
    let selectedTeam = null;
    let selectedSettingsType = null;
    let customRatings = {};
    let teamsData = [];

    document.addEventListener('DOMContentLoaded', function() {
        init();
    });

    function init() {
        collectTeamsData();
        setupEventListeners();
    }

        function collectTeamsData() {
        const teamRows = document.querySelectorAll('.team-row');

        teamRows.forEach(row => {
            const teamId = row.dataset.teamId;
            const teamName = row.dataset.teamName;
            const teamPhoto = row.dataset.teamPhoto;
            const teamUrl = row.dataset.teamUrl;
            const wins = parseInt(row.dataset.wins || 0);
            const draws = parseInt(row.dataset.draws || 0);
            const losses = parseInt(row.dataset.losses || 0);
            const points = parseInt(row.dataset.points || 0);
            const goals = parseInt(row.dataset.goals || 0);
            const misses = parseInt(row.dataset.misses || 0);
            const defaultRating = parseInt(row.dataset.defaultRating || 50);

            const logoPath = `/Eplphoto/${teamPhoto}.${teamUrl}`;

            teamsData.push({
                id: teamId,
                name: teamName,
                photo: teamPhoto,
                url: teamUrl,
                logo: logoPath,
                wins: wins,
                draws: draws,
                losses: losses,
                goals: goals,
                misses: misses,
                points: points,
                defaultRating: defaultRating
            });
        });
    }

    function setupEventListeners() {
        document.querySelectorAll('.team-row').forEach(row => {
            row.addEventListener('click', function() {
                selectTeam(this.dataset.teamId);
            });
        });

        document.getElementById('default-settings').addEventListener('click', function() {
            selectSettingsType('default');
        });

        document.getElementById('custom-settings').addEventListener('click', function() {
            selectSettingsType('custom');
            renderCustomRatingsTable();
        });

        document.getElementById('confirm-btn').addEventListener('click', startGame);

        document.getElementById('restart-btn').addEventListener('click', restartGame);

        document.getElementById('custom-table-epl').addEventListener('input', function(e) {
            if (e.target.classList.contains('rating-input')) {
                handleRatingInput(e.target);
            }
        });
    }

    function handleRatingInput(inputElement) {
        const teamId = inputElement.dataset.teamId;
        const value = parseInt(inputElement.value);

        if (value < 1) inputElement.value = 1;
        if (value > 100) inputElement.value = 100;

        customRatings[teamId] = parseInt(inputElement.value) || 1;
        checkAllRatingsFilled();
    }

    function selectTeam(teamId) {
        selectedTeam = teamId;

        document.querySelectorAll('.team-row').forEach(row => {
            row.classList.remove('selected');
        });

        document.querySelector(`.team-row[data-team-id="${teamId}"]`).classList.add('selected');

        const team = teamsData.find(t => t.id === teamId);
        if (team) {
            document.getElementById('selected-team-name').textContent = team.name;
            document.getElementById('selected-team-stats').innerHTML = `
                <p>В: ${team.wins} | ВО: ${team.draws} | П: ${team.losses} | Разница: ${team.goals}-${team.misses} | Очки: ${team.points}</p>
                <p>Рейтинг по умолчанию: ${team.defaultRating}</p>
            `;
            document.getElementById('selected-team-display').style.display = 'block';
        }

        document.getElementById('settings-selection').style.display = 'block';
        document.getElementById('settings-selection').scrollIntoView({ behavior: 'smooth' });
    }

    function selectSettingsType(type) {
        selectedSettingsType = type;

        document.getElementById('default-settings').classList.remove('selected');
        document.getElementById('custom-settings').classList.remove('selected');

        if (type === 'default') {
            document.getElementById('default-settings').classList.add('selected');
            document.getElementById('custom-ratings').classList.remove('active');
            document.getElementById('confirm-btn').classList.add('active');
        } else if (type === 'custom') {
            document.getElementById('custom-settings').classList.add('selected');
            document.getElementById('custom-ratings').classList.add('active');
        }

        document.getElementById('confirm-btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

        function renderCustomRatingsTable() {
        document.getElementById('custom-table-epl').innerHTML = '';

        customRatings = {};

        teamsData.forEach(team => {
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${team.logo}" style="width: 30px; height: 30px; object-fit: contain;" />
                        <span>${team.name}</span>
                    </div>
                </td>
                <td>
                    <input type="number" class="rating-input" data-team-id="${team.id}"
                           min="1" max="100" value="${team.defaultRating}">
                </td>
            `;

            document.getElementById('custom-table-epl').appendChild(row);
            customRatings[team.id] = team.defaultRating;
        });

        document.querySelectorAll('.rating-input').forEach(input => {
            input.addEventListener('input', function() {
                handleRatingInput(this);
            });
        });

        checkAllRatingsFilled();
    }

    function checkAllRatingsFilled() {
        const allFilled = teamsData.every(team => {
            return customRatings[team.id] && customRatings[team.id] >= 1 && customRatings[team.id] <= 100;
        });

        if (allFilled) {
            document.getElementById('confirm-btn').classList.add('active');
        } else {
            document.getElementById('confirm-btn').classList.remove('active');
        }

        return allFilled;
    }

    function startGame() {
        if (!selectedTeam) {
            alert('Пожалуйста, выберите команду!');
            return;
        }

        if (!selectedSettingsType) {
            alert('Пожалуйста, выберите тип настроек!');
            return;
        }

        if (selectedSettingsType === 'custom' && !checkAllRatingsFilled()) {
            alert('Пожалуйста, установите рейтинги для всех команд!');
            return;
        }

        const team = teamsData.find(t => t.id === selectedTeam);
        const finalRatings = generateFinalRatings();
        showGameScreen(team, finalRatings);
    }

    function generateFinalRatings() {
        const ratings = {};

        teamsData.forEach(team => {
            if (selectedSettingsType === 'default') {
                ratings[team.id] = team.defaultRating;
            } else {
                ratings[team.id] = customRatings[team.id];
            }
        });

        return ratings;
    }

       function showGameScreen(selectedTeam, ratings) {
        document.getElementById('selected-team-message').textContent = `Вы играете за команду "${selectedTeam.name}"!`;

        const finalTableBody = document.getElementById('final-ratings-table');
        finalTableBody.innerHTML = '';

        const sortedTeams = [...teamsData].sort((a, b) => ratings[b.id] - ratings[a.id]);

        sortedTeams.forEach((team, index) => {
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${index + 1}</td>
                <td><img src="${team.logo}" style="width: 30px; height: 30px; object-fit: contain;" /></td>
                <td>
                    <div class="team-cell">
                        <span>${team.name} ${team.id === selectedTeam.id ? '(Ваша команда)' : ''}</span>
                    </div>
                </td>
                <td>${team.wins}</td>
                <td>${team.draws}</td>
                <td>${team.losses}</td>
                <td>${team.goals}</td>
                <td>${team.misses}</td>
                <td>${team.goals - team.misses}</td>
                <td>${team.points}</td>
                <td>${ratings[team.id]}</td>
            `;

            finalTableBody.appendChild(row);
        });

        document.getElementById('team-selection').style.display = 'none';
        document.getElementById('settings-selection').style.display = 'none';
        document.getElementById('in-game-screen').classList.add('active');

        document.getElementById('in-game-screen').scrollIntoView({ behavior: 'smooth' });
    }

    function restartGame() {
        selectedTeam = null;
        selectedSettingsType = null;
        customRatings = {};

        document.querySelectorAll('.team-row').forEach(row => {
            row.classList.remove('selected');
        });

        document.getElementById('default-settings').classList.remove('selected');
        document.getElementById('custom-settings').classList.remove('selected');
        document.getElementById('custom-ratings').classList.remove('active');
        document.getElementById('confirm-btn').classList.remove('active');
        document.getElementById('selected-team-display').style.display = 'none';

        document.getElementById('team-selection').style.display = 'block';
        document.getElementById('settings-selection').style.display = 'block';
        document.getElementById('in-game-screen').classList.remove('active');

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>