@using DenchikSportsRu.Models.Page;
@model Formula;


@{
    Layout = "_Layout";
}
<style>
    main {
        text-align: center;
        margin-right: 20px;
        margin-left: 20px;
    }

    .tables-container {
        display: flex;
        gap: 75px;
        justify-content: space-between;
    }

    .table-wrapper {
        flex: 1;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }


    tr {
        text-align: center;
        height: 40px;
    }

    th, td {
        padding: 8px;
        border: 1px solid #ddd;
    }

    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    .leader-row {
        background-color: #e8f5e8;
    }

    .middle-row {
        background-color: #ffffff;
    }

    .team-name {
        text-align: left;
        font-weight: bold;
    }

    caption {
        caption-side: top;
        font-size: 1.2em;
        font-weight: 700;
        color: black;
        margin-bottom: 10px;
        text-align: center;
    }

    .table-racer, .table-teams {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    .table-racer, .table-teams {
        width: 100%;
        border-collapse: collapse;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
    }

        .table-racer caption, .table-teams caption {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            color: #fff;
            caption-side: top;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .table-racer thead, .table-teams thead {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .table-racer th, .table-teams th,
        .table-racer td, .table-teams td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-racer tbody tr, .table-teams tbody tr {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            .table-racer tbody tr:hover, .table-teams tbody tr:hover {
                background-color: rgba(255, 255, 255, 0.1);
            }

            .table-racer tbody tr.selected, .table-teams tbody tr.selected {
                background-color: rgba(254, 180, 123, 0.2);
                box-shadow: 0 0 10px rgba(254, 180, 123, 0.3);
            }

                .table-racer tbody tr.selected td, .table-teams tbody tr.selected td {
                    font-weight: bold;
                }

    .game-setup {
        display: flex;
        flex-direction: column;
        gap: 30px;
        margin-top: 20px;
    }

    .confirm-btn {
        display: none;
        margin: 25px auto 0;
        padding: 15px 40px;
        background: linear-gradient(to right,, );
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px #4C0E0F;
    }

        .confirm-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px #4C0E0F;
        }

        .confirm-btn.active {
            display: block;
        }

    .custom-ratings {
        display: none;
        margin-top: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

        .custom-ratings.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

    .custom-ratings-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

        .custom-ratings-table th, .custom-ratings-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-ratings-table th {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .custom-ratings-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

    .setup-section {
        background-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
        justify-content: center;
        text-align: center;
    }

        .setup-section h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            text-align: center;
        }

            .setup-section h2 i {
                font-size: 1.6rem;
            }

    .in-game-screen {
        display: none;
        text-align: center;
        padding: 40px 20px;
        animation: fadeIn 0.8s ease;
    }

        .in-game-screen.active {
            display: block;
        }

    .game-title {
        font-size: 2.5rem;
        margin-bottom: 30px;
        background: linear-gradient(to right, #4C0E0F);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .game-message {
        font-size: 1.5rem;
        margin-bottom: 40px;
        color: #feb47b;
    }

    .final-ratings-table {
        width: 100%;
        max-width: initial;
        margin: 0 auto;
        border-collapse: collapse;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

        .final-ratings-table th {
            background-color: #4C0E0F;
            padding: 15px;
            font-size: 1.2rem;
            color: #FFFFFF;
        }

        .final-ratings-table td {
            padding: 15px;
            text-align: center;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .final-ratings-table tr:last-child td {
            border-bottom: none;
        }

        .final-ratings-table .team-cell {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

    .restart-btn {
        margin-top: 40px;
        padding: 15px 40px;
        background: linear-gradient(to right, #4C0E0F, red);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px #4C0E0F;
    }

        .restart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px #4C0E0F;
        }

    .settings-options {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .settings-btn {
        flex: 1;
        min-width: 200px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        border-radius: 10px;
        color: white;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .settings-btn.selected {
            background: rgba(76, 14, 15, 0.3);
            border-color: #4C0E0F;
        }

    .settings-icon {
        font-size: 1.5rem;
    }

    .selected-team-info {
        background-color: rgba(76, 14, 15, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 4px solid #4C0E0F;
    }
</style>

<main id="content" class="site-main post-43 page type-page status-publish hentry">
    <div class="page-content">
        <div data-elementor-type="wp-page" data-elementor-id="43" class="elementor elementor-43" data-elementor-post-type="page">
            <section class="elementor-section elementor-top-section elementor-element elementor-element-df04e12 elementor-section-boxed elementor-section-height-default elementor-section-height-default" data-id="df04e12" data-element_type="section" data-settings="{&quot;jet_parallax_layout_list&quot;:[]}">
                <div class="elementor-container elementor-column-gap-no">
                    <div class="elementor-column elementor-col-100 elementor-top-column elementor-element elementor-element-65ee644" data-id="65ee644" data-element_type="column">
                        <div class="elementor-widget-wrap elementor-element-populated">
                            <div class="elementor-element elementor-element-09c7ee9 elementor-widget elementor-widget-jet-blog-smart-tiles" data-id="09c7ee9" data-element_type="widget" data-widget_type="jet-blog-smart-tiles.default">
                                <div class="elementor-widget-container">
                                    <div class="game-setup">
                                        <section class="setup-section" id="team-selection">
                                            <h2><i class="fas fa-users"></i>Выберите тип игры</h2>
                                            <div class="tables-container">
                                                <div class="table-wrapper">
                                                    <table class="table-racer">
                                                        <caption>Личный зачет</caption>
                                                        <thead>
                                                            <tr>
                                                                <th>Место</th>
                                                                <th></th>
                                                                <th>Спортсмен</th>
                                                                <th>Команда</th>
                                                                <th>Очки</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @{
                                                                int position = 1;
                                                                foreach (var row in Model.List.OrderByDescending(x => x.points))
                                                                {
                                                                    <tr class="racer-row"
                                                                    data-racer-id="@row.id" 
                                                                    data-racer-team-name="@row.racer_team_name" 
                                                                    data-racer-name="@row.racer_name" 
                                                                    data-racer-surname="@row.racer_surname" 
                                                                    data-racer-photo="@row.racer_photo" 
                                                                    data-racer-url="@row.racer_url" 
                                                                    data-points="@row.points">
                                                                        <td>@position</td>
                                                                        <td><img src="~/f1/@row.racer_photo.@row.racer_url" style="width: 30px; height: 30px; object-fit: contain; vertical-align: middle;" /></td>
                                                                        <td><strong>@row.racer_name @row.racer_surname</strong></td>
                                                                        <td>@row.racer_team_name</td>
                                                                        <td>@row.points</td>
                                                                    </tr>
                                                                    position++;
                                                                }
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="table-wrapper">
                                                    <table class="table-teams">
                                                        <caption>Кубок конструкторов</caption>
                                                        <thead>
                                                            <tr>
                                                                <th>Место</th>
                                                                <th></th>
                                                                <th>Команда</th>
                                                                <th>Очки</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @{
                                                                var teamPointsSimple = Model.List
                                                                .Where(r => !string.IsNullOrEmpty(r.racer_team_name))
                                                                .GroupBy(r => r.racer_team_name)
                                                                .Select(g => new
                                                                {
                                                                    TeamName = g.Key,
                                                                    TeamPhoto = g.First().racer_team_photo,
                                                                    TeamUrl = g.First().racer_url,
                                                                    Points = g.Sum(r => r.points)
                                                                })
                                                                .OrderByDescending(t => t.Points)
                                                                .ToList();

                                                                int teamPositionSimple = 1;
                                                                foreach (var team in teamPointsSimple)
                                                                {
                                                                    <tr class="team-row" 
                                                                        data-teamphoto="@team.TeamPhoto"
                                                                        data-teamurl="@team.TeamUrl"
                                                                        data-team-name="@team.TeamName"
                                                                        data-team-points="@team.Points">
                                                                        <td>@teamPositionSimple</td>
                                                                        <td><img src="~/f1/@team.TeamPhoto.@team.TeamUrl" style="width: 30px; height: 30px; object-fit: contain; vertical-align: middle;" /></td>
                                                                        <td><strong>@team.TeamName</strong></td>
                                                                        <td><strong>@team.Points</strong></td>
                                                                    </tr>
                                                                    teamPositionSimple++;
                                                                }
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </section>
                                        <section class="setup-section" id="settings-selection" style="display: none;">
                                            <div id="selected-team-display" class="selected-team-info" style="display: none;">
                                                <h2>Выбранная команда: <span id="selected-team-name"></span></h2>
                                                <div id="selected-team-stats"></div>
                                            </div>
                                            <h2><i class="fas fa-cog"></i> Выберите тип настроек</h2>
                                            <div class="settings-options">
                                                <button class="settings-btn" id="default-settings">
                                                    <i class="fas fa-bolt settings-icon"></i>
                                                    <span>По умолчанию</span>
                                                    <small>Использовать стандартные рейтинги</small>
                                                </button>
                                                <button class="settings-btn" id="custom-settings">
                                                    <i class="fas fa-sliders-h settings-icon"></i>
                                                    <span>Кастомизированные</span>
                                                    <small>Настроить рейтинги вручную</small>
                                                </button>
                                            </div>

                                            <div class="custom-ratings" id="custom-ratings">
                                                <p>Установите рейтинг для каждой команды (от 1 до 100):</p>
                                                <div class="tables-container">
                                                    <div class="table-wrapper racer-table">
                                                        <table class="table-racer">
                                                            <caption>Личный зачет</caption>
                                                            <thead>
                                                                <tr>
                                                                    <th></th>
                                                                    <th>Гонщик</th>
                                                                    <th>Очки</th>
                                                                    <th>Рейтинг</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="custom-table-racer">
                                                            </tbody>
                                                        </table>
                                                    </div>

                                                    <div class="table-wrapper teams-table">
                                                        <table class="table-teams">
                                                            <caption>Кубок конструкторов</caption>
                                                            <thead>
                                                                <tr>
                                                                    <th></th>
                                                                    <th>Команда</th>
                                                                    <th>Очки</th>
                                                                    <th>Рейтинг</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="custom-table-teams">
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>

                                            <button class="confirm-btn" id="confirm-btn">Подтвердить и начать игру</button>
                                        </section>
                                        <section class="in-game-screen" id="in-game-screen">
                                            <h2 class="game-title">Вы в игре!</h2>
                                            <p class="game-message" id="selected-team-message"></p>

                                            <table class="final-ratings-table">
                                                <thead>
                                                    <tr>
                                                    <th>Место</th>
                                                    <th></th>
                                                    <th>Гонщик / Команда</th>
                                                    <th>Очки</th>
                                                    <th>Рейтинг</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="final-ratings-table">
                                                </tbody>
                                            </table>

                                            <button class="restart-btn" id="restart-btn"><i class="fas fa-redo"></i> Начать заново</button>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>

<script>

    let selectedEntity = null;
    let selectedSettingsType = null;
    let customRatings = {};

    let racersData = [];
    let teamsData = [];

    document.addEventListener('DOMContentLoaded', init);

    function init() {
        collectData();
        setupEventListeners();
    }


    function collectData() {

        document.querySelectorAll('.racer-row').forEach(row => {

            racersData.push({
                id: row.dataset.racerId,
                name: `${row.dataset.racerName} ${row.dataset.racerSurname}`,
                team: row.dataset.racerTeamName,
                photo: row.querySelector('img')?.src,
                points: parseInt(row.dataset.points),
                defaultRating: Math.min(100, 60 + parseInt(row.dataset.points) % 40)
            });
        });

        document.querySelectorAll('.team-row').forEach(row => {

            teamsData.push({
                id: row.dataset.teamName,
                name: row.dataset.teamName,
                photo: row.querySelector('img')?.src,
                points: parseInt(row.dataset.teamPoints),
                defaultRating: Math.min(100, 60 + parseInt(row.dataset.teamPoints) % 40)
            });
        });
    }

    function setupEventListeners() {

        document.querySelectorAll('.racer-row').forEach(row => {
            row.addEventListener('click', () => selectEntity(row.dataset.racerId, 'racer'));
        });

        document.querySelectorAll('.team-row').forEach(row => {
            row.addEventListener('click', () => selectEntity(row.dataset.teamName, 'team'));
        });

        document.getElementById('default-settings')
            .addEventListener('click', () => selectSettings('default'));

        document.getElementById('custom-settings')
            .addEventListener('click', () => {
                selectSettings('custom');
                renderCustomRatings();
            });

        document.getElementById('confirm-btn')
            .addEventListener('click', startGame);

        document.getElementById('restart-btn')
            .addEventListener('click', restartGame);
    }


    function selectEntity(id, type) {

        selectedEntity = id;

        document.querySelectorAll('.racer-row, .team-row')
            .forEach(r => r.classList.remove('selected'));

        if (type === 'racer') {
            document.querySelector(`.racer-row[data-racer-id="${id}"]`)
                .classList.add('selected');
        } else {
            document.querySelector(`.team-row[data-team-name="${id}"]`)
                .classList.add('selected');
        }

        const entity =
            type === 'racer'
                ? racersData.find(r => r.id === id)
                : teamsData.find(t => t.id === id);

        document.getElementById('selected-team-name').textContent = entity.name;
        document.getElementById('selected-team-stats').innerHTML =
            `Очки: ${entity.points} | Рейтинг по умолчанию: ${entity.defaultRating}`;

        document.getElementById('selected-team-display').style.display = 'block';
        document.getElementById('settings-selection').style.display = 'block';
        document.getElementById('settings-selection').scrollIntoView({ behavior: 'smooth' });
    }


    function selectSettings(type) {

        selectedSettingsType = type;

        document.getElementById('default-settings').classList.remove('selected');
        document.getElementById('custom-settings').classList.remove('selected');

        if (type === 'default') {
            document.getElementById('default-settings').classList.add('selected');
            document.getElementById('custom-ratings').classList.remove('active');
            document.getElementById('confirm-btn').classList.add('active');
        } else {
            document.getElementById('custom-settings').classList.add('selected');
            document.getElementById('custom-ratings').classList.add('active');
        }
    }


    function renderCustomRatings() {

        const racerBody = document.getElementById('custom-table-racer');
        const teamBody = document.getElementById('custom-table-teams');

        racerBody.innerHTML = '';
        teamBody.innerHTML = '';

        customRatings = {};

        racersData.forEach(r => {

            const row = document.createElement('tr');
            row.innerHTML = `
                <td></td>
                <td>${r.name}</td>
                <td>${r.points}</td>
                <td>
                    <input type="number" class="rating-input"
                           data-id="${r.id}"
                           min="1" max="100"
                           value="${r.defaultRating}">
                </td>
            `;

            racerBody.appendChild(row);
            customRatings[r.id] = r.defaultRating;
        });

        teamsData.forEach(t => {

            const row = document.createElement('tr');
            row.innerHTML = `
                <td></td>
                <td>${t.name}</td>
                <td>${t.points}</td>
                <td>
                    <input type="number" class="rating-input"
                           data-id="${t.id}"
                           min="1" max="100"
                           value="${t.defaultRating}">
                </td>
            `;

            teamBody.appendChild(row);
            customRatings[t.id] = t.defaultRating;
        });

        document.querySelectorAll('.rating-input').forEach(input => {
            input.addEventListener('input', () => {
                let value = parseInt(input.value);
                if (value < 1) value = 1;
                if (value > 100) value = 100;
                input.value = value;
                customRatings[input.dataset.id] = value;
                checkRatings();
            });
        });

        checkRatings();
    }

    function checkRatings() {

        const allFilled =
            [...racersData, ...teamsData]
                .every(e => customRatings[e.id] >= 1 && customRatings[e.id] <= 100);

        document.getElementById('confirm-btn')
            .classList.toggle('active', allFilled);
    }

    function startGame() {

        if (!selectedEntity || !selectedSettingsType) {
            alert('Выберите участника и тип настроек!');
            return;
        }

        const ratings = {};

        if (selectedSettingsType === 'default') {

            racersData.forEach(r => ratings[r.id] = r.defaultRating);
            teamsData.forEach(t => ratings[t.id] = t.defaultRating);

        } else {

            Object.assign(ratings, customRatings);
        }

        showGameScreen(ratings);
    }


    function showGameScreen(ratings) {

        const tbody = document.getElementById('final-ratings-table');
        tbody.innerHTML = '';

        const combined = [...racersData, ...teamsData]
            .sort((a, b) => ratings[b.id] - ratings[a.id]);

        combined.forEach((e, index) => {

            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${index + 1}</td>
                <td><img src="${e.photo}" width="30"></td>
                <td>${e.name}</td>
                <td>${e.points}</td>
                <td>${ratings[e.id]}</td>
            `;

            if (e.id === selectedEntity) {
                row.style.backgroundColor = "rgba(254,180,123,0.3)";
                row.style.fontWeight = "bold";
            }

            tbody.appendChild(row);
        });

        document.getElementById('team-selection').style.display = 'none';
        document.getElementById('settings-selection').style.display = 'none';
        document.getElementById('in-game-screen').classList.add('active');
    }


    function restartGame() {
        location.reload();
    }

</script>

